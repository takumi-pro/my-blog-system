---
title: "AWS CDKã§è¸ã¿å°ã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ¢"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
publishedAt: "2023/08/14"
---

æ¥­å‹™ã§AWS CDKã‚’ä½¿ã£ã¦ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’ã™ã‚‹ã“ã¨ã«ãªã£ãŸãŸã‚ã€ç°¡å˜ãªè¸ã¿å°ã‚µãƒ¼ãƒã‚’CDKã§æ§‹ç¯‰ã—ã¦ã¿ãŸã€‚

## ç’°å¢ƒ
- CDKï¼š2.90.0

## CDKã‚³ãƒ¼ãƒ‰
cdkã«`BasionHostLinux`ã¨ã„ã†è¸ã¿å°ã‚µãƒ¼ãƒç”¨ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ãã‚Œã‚’ä½¿ç”¨ã—ãŸã€‚

```typescript
import { Stack, StackProps } from 'aws-cdk-lib'
import * as ec2 from 'aws-cdk-lib/aws-ec2'
import { Construct } from 'constructs'
import * as iam from 'aws-cdk-lib/aws-iam';

export class CdkBasionStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props)

    const vpc = new ec2.Vpc(this, 'basionVPC', {
      cidr: '10.0.0.0/16',
      maxAzs: 1,
      subnetConfiguration: [
        {
          name: 'public-basion-subnet',
          subnetType: ec2.SubnetType.PUBLIC,
          cidrMask: 24,
        },
      ],
    })

    // Security Group
    const basionSG = new ec2.SecurityGroup(this, 'basionSG', {
      vpc,
      allowAllOutbound: true,
    })
    basionSG.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.tcp(22), 'Allow SSH from anywhere')

    // EC2 Instance
    const basionServer = new ec2.BastionHostLinux(this, 'basionServer', {
      vpc,
      subnetSelection: { subnetType: ec2.SubnetType.PUBLIC },
      securityGroup: basionSG,
    })
    basionServer.allowSshAccessFrom(ec2.Peer.anyIpv4())
  }
}
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨è©²å½“ã®ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹
```bash
cdk deploy
```

SSHæ¥ç¶šã™ã‚‹éš›ã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDãŒå¿…è¦ã«ãªã‚‹ãŸã‚ç¢ºèªã—ã¦ãŠã

## Session Managerãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
```bash
curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "sessionmanager-bundle.zip"

# zipè§£å‡
unzip sessionmanager-bundle.zip

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin
```

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å…¬é–‹éµã‚’é€ä¿¡ã™ã‚‹
sshæ¥ç¶šã™ã‚‹å‰ã«å¯¾è±¡ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å…¬é–‹éµã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```bash
aws ec2-instance-connect send-ssh-public-key \
    --instance-id {instance-id} \
    --availability-zone {az-name} \
    --instance-os-user ec2-user \
    --ssh-public-key file://{public-keyfile-path}
```


## SSH Configã®è¨­å®š
ä»¥ä¸‹ã®å†…å®¹ã‚’SSH Configã«è¨­å®šã™ã‚‹

```bash
Host cdk-basion
    User ec2-user
    HostName {instance-id}
    Port 22
    ProxyCommand sh -c "aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p' --profile {profile-name}"
    IdentityFile {private-keyfile-path}
```

## æ¥ç¶šãƒ†ã‚¹ãƒˆ
```bash
ssh cdk-basion
```

## å‚è€ƒ
- [macOSã§ã®Session Managerãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/install-plugin-macos-overview.html)

