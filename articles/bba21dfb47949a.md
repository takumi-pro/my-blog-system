---
title: "GitHub Actionsã‚’ä½¿ç”¨ã—ã¦CI/CDã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸ—"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
publishedAt: "2023/06/12"
---

## å‰æ
- æ—¢ã«AWSä¸Šã«ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ¸ˆã¿
- `buildspec.yml`ä½œæˆæ¸ˆã¿
- slimãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®PHPã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- CodeBuildã§ã¯PHPUnitã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã¨PHP_CodeSnifferã«ã‚ˆã‚‹é™çš„è§£æã‚’è¡Œã†

ä»¥ä¸‹ã€ä»Šå›ã®`buildspec.yml`
```yaml
version: '0.2'
phases:
  install:
    runtime-versions:
      php: '8.2'
    commands:
    - composer install
  build:
    commands:
    - composer run phpunit
    - composer run phpcs
artifacts:
  type: zip
  files:
    - '**/*'
```

## AWSå´ã§ã‚„ã‚‹ã“ã¨

### OpenID Connect IDãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ä½œæˆ
IAMã‹ã‚‰ã€ŒIDãƒ—ãƒ­ãƒã‚¤ãƒ€ã€ã®ã€ŒOpenID Connectã€ã‚’é¸æŠã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®URLã«ã¯ `https://token.actions.githubusercontent.com`ã‚’å…¥åŠ›ã™ã‚‹ã€‚å¯¾è±¡è€…ã®å…¥åŠ›æ¬„ã«ã¯ã€å…¬å¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ [aws-actions/configure-aws-credentials](https://github.com/aws-actions/configure-aws-credentials)ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚`sts.amazonaws.com`ã‚’å…¥åŠ›ã€‚

- ãƒ—ãƒ­ãƒã‚¤ãƒ€URL - https://token.actions.githubusercontent.com
- å¯¾è±¡è€… - sts.amazonaws.com

### GitHub OIDC IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ­ãƒ¼ãƒ«ã®è¨­å®š
IAMã§ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚ä¿¡é ¼ã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã¯ã€Œã‚¦ã‚§ãƒ–ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚’é¸æŠã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨audienceã«ã¯ãã‚Œãã‚Œä»¥ä¸‹ã‚’é¸æŠã™ã‚‹ã€‚
- ãƒ—ãƒ­ãƒã‚¤ãƒ€ - token.actions.githubusercontent.com
- Audience - sts.amazonaws.com

ãƒãƒªã‚·ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ãŸ
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::[aws-account-id]:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:sub": "repo:takumi-pro/slim-deployment:ref:refs/heads/main",
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                }
            }
        }
    ]
}
```

## GitHub Actionså´ã§ã‚„ã‚‹ã“ã¨
### permissionsã®è¨­å®š
GitHub OIDCã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«æ¨©é™ã‚’æ“ä½œã™ã‚‹ã€‚workflowã®jobã§`permissions`ã‚’æŒ‡å®šã—ã¦`id-token: write`ã¨`contents: read`ã‚’è¿½åŠ ã™ã‚‹ã€‚

### actionsã®è¨­å®š
[aws-actions/configure-aws-credentials](https://github.com/aws-actions/configure-aws-credentials)ã‚’workflowã®actionã«è¿½åŠ ã™ã‚‹ã€‚

æœ€çµ‚çš„ãªworkflowã¯ä»¥ä¸‹ã¨ãªã‚‹ã€‚
```yaml
name: build
on:
  pull_request:
  push:

jobs:
  codebuild:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::656337613100:role/slim-github-oidcid
          role-session-name: slim-session
          aws-region: ap-northeast-1
```

## å‚è€ƒ
- [GitHub Actionsã§AWSã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’æ¸¡ã•ãšã«CICDã‚’å®Ÿè¡Œã—ã¦ã¿ãŸ](https://note.com/shift_tech/n/n61146784b54f#66aefa0c-cc27-484d-8cd9-f29fb434034e)
- [Configuring OpenID Connect in Amazon Web Services](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)
- [Configure AWS Credentials for GitHub Actions](https://github.com/aws-actions/configure-aws-credentials)